#!/usr/bin/env bash
# Migrate from Prettier to oxfmt

set -e

# Detect package manager
detect_package_manager() {
  if [ -f "bun.lock" ] || [ -f "bun.lockb" ]; then
    echo "bun"
  elif [ -f "pnpm-lock.yaml" ]; then
    echo "pnpm"
  elif [ -f "yarn.lock" ]; then
    echo "yarn"
  elif [ -f "package-lock.json" ]; then
    echo "npm"
  else
    echo "unknown"
  fi
}

PM=$(detect_package_manager)

if [ "$PM" = "unknown" ]; then
  echo "Error: Could not detect package manager. Make sure you're in a project directory with package.json"
  exit 1
fi

echo "Detected package manager: $PM"

# Remove prettier packages
echo "Removing prettier packages..."
case $PM in
  npm)
    npm uninstall prettier
    ;;
  yarn)
    yarn remove prettier
    ;;
  pnpm)
    pnpm remove prettier
    ;;
  bun)
    bun remove prettier
    ;;
esac

# Install oxfmt
echo "Installing oxfmt..."
case $PM in
  npm)
    npm install --save-dev oxfmt
    ;;
  yarn)
    yarn add -D oxfmt
    ;;
  pnpm)
    pnpm add -D oxfmt
    ;;
  bun)
    bun add -d oxfmt
    ;;
esac

# Read .prettierignore if it exists (before deleting it)
IGNORE_PATTERNS=()
if [ -f ".prettierignore" ]; then
  echo "Reading .prettierignore..."
  while IFS= read -r line || [ -n "$line" ]; do
    # Skip empty lines and comments
    if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
      IGNORE_PATTERNS+=("$line")
    fi
  done < .prettierignore
fi

# Delete prettier files
echo "Deleting prettier configuration files..."
[ -f ".prettierrc" ] && rm .prettierrc
[ -f ".prettierrc.json" ] && rm .prettierrc.json
[ -f ".prettierrc.js" ] && rm .prettierrc.js
[ -f ".prettierrc.cjs" ] && rm .prettierrc.cjs
[ -f ".prettierrc.mjs" ] && rm .prettierrc.mjs
[ -f ".prettierrc.yaml" ] && rm .prettierrc.yaml
[ -f ".prettierrc.yml" ] && rm .prettierrc.yml
[ -f ".prettierignore" ] && rm .prettierignore

# Create .oxfmtrc.json using oxfmtrc binary
echo "Creating .oxfmtrc.json..."
oxfmtrc

# Add ignorePatterns using jq if patterns exist
if [ ${#IGNORE_PATTERNS[@]} -gt 0 ]; then
  echo "Adding ignore patterns to .oxfmtrc.json..."
  TMP_FILE=$(mktemp)

  # Build jq filter to add ignorePatterns array
  JQ_FILTER='.ignorePatterns = ['
  for i in "${!IGNORE_PATTERNS[@]}"; do
    if [ $i -gt 0 ]; then
      JQ_FILTER+=','
    fi
    # Use jq to properly escape the string
    ESCAPED=$(printf '%s' "${IGNORE_PATTERNS[$i]}" | jq -Rs .)
    JQ_FILTER+="$ESCAPED"
  done
  JQ_FILTER+=']'

  jq "$JQ_FILTER" .oxfmtrc.json > "$TMP_FILE" && mv "$TMP_FILE" .oxfmtrc.json
fi

# Update package.json scripts
if [ -f "package.json" ]; then
  echo "Updating package.json scripts..."

  sed -i '' \
    -e 's/prettier --write /oxfmt /g' \
    -e 's/prettier --check /oxfmt --check /g' \
    package.json

  echo "Updated package.json scripts"
fi

echo "Migration complete!"
echo "Created .oxfmtrc.json with ${#IGNORE_PATTERNS[@]} ignore pattern(s) from .prettierignore"
