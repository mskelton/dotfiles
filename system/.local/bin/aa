#!/usr/bin/env bash
# Approve and auto-merge a PR
# Usage: aa [-R <repo>] [branch]

auto_merge_repos=(
	"ramp/web"
	"ramp/core"
)

flags=()

while [[ $# -gt 0 ]]; do
	case $1 in
	-R)
		repo="$2"
		shift 2
		;;
	-*)
		flags+=("$1")
		shift
		;;
	*)
		branch="$1"
		shift
		;;
	esac
done

# Set repo if -R was not specified
if [[ -z "$repo" ]]; then
	repo=$(gh repo view --json nameWithOwner --jq '.nameWithOwner')
fi

# Determine if we should add the auto merge flag
if [[ " ${auto_merge_repos[@]} " =~ " $repo " ]]; then
	flags+=("--auto")
fi

gh pr review --approve -R "$repo" "$branch"
gh pr merge -R "$repo" "$branch" "${flags[@]}"
